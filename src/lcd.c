
#include <xc.h>
#include "../headers/lcd.h"
#include "../headers/i2c_master.h"
#include "../headers/character.h"
#define LCD_ADDR 0x3C
#define ROWS 0x04
#define COLS 0x80
#define PAGES 0x04
#define LCDWIDTH 128
#define LCDHEIGHT 32
char lcd_buffer [ROWS * COLS] = {
   0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
   0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
   0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0,
   0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
   0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
   0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC,
   0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE,
   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
   0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
   0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
   0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0,
   0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
   0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
   0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC,
   0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE,
   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
   0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
   0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
   0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0,
   0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
   0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
   0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC,
   0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE,
   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
   0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
   0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
   0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0,
   0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
   0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8, 0xF8,
   0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC,
   0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE,
   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
}; // 32 x 128 pixels    

static int cursor_x = 0;
static int cursor_y = 0;
/**
 * Writes a command to the LCD
 * @param cmd 
 * the command to write
 */
void command(unsigned char cmd) {
    char msg[2];
    msg[0] = CONTROL_CMD;
    msg[1] = cmd;
    I2C_master_write(msg, 2, LCD_ADDR);
}
/**
 * Initialize the display
 */
void lcd_init() {
    command(SET_DISPLAYOFF);
    command(SET_DISPLAYCLK);
    command(0x80); // Recommended clock divider
    
    command(SET_DISPLAYOFFSET);
    command(0x00);
    
    command(SET_MULTIPLEX);
    command(LCDWIDTH - 1);
    
    command(SET_DISPLAYSTART | 0x0);
    
    command(SET_MEMORYMODE);
    command(0x00);
    
    command(SET_SEGMENTREMAP);
    
    command(SET_COMOUTPUT);
    
    command(SET_COMPINS);
    command(0x02);
    
    command(SET_CONTRAST);
    command(0xCF);
    
    command(SET_DISPLAYALLON_RESUME);
    
    command(SET_NORMALDISPLAY);
    
    command(SET_CHARGEPUMP);
    command(0x14); // ON
    
    command(DISABLE_SCROLL);
    
    command(SET_DISPLAYON);
    
}
/**
 * Update the display with the lcd_buffer
 */
void lcd_update() {
    int i, j, max;
    char data[33];
    // Set column start
    command(SET_COLADDR);
    command(0x00);
    command(LCDWIDTH - 1);
    
    // Set page start
    command(SET_PAGEADDR);
    command(0x00);
    command(0xFF);
    max = ROWS * COLS;
    for(i = 0; i < max; i += 32) {
        data[0] = CONTROL_DATA;
        for(j = 0; j < 32; j++) {
            data[j + 1] = lcd_buffer[i + j];
        }
        I2C_master_write(data, 33, LCD_ADDR);
    }
}
/**
 * Sets a pixel to the designated color
 * @param i
 *  row: 0 - 64
 * @param j
 *  column: 0 - 127
 * @param val
 *  color: BLACK, WHITE, INVERT
 */
void set_pixel(unsigned char i, unsigned char j, unsigned char val) {
    unsigned int index = j + (i/8) * COLS;
    unsigned int offset = i % 8;
    if( val == BLACK ) {
        CLEARBIT(lcd_buffer[index], offset);
    } else if(val == WHITE ) {
        SETBIT(lcd_buffer[index], offset);
    } else { // Invert
        INVBIT(lcd_buffer[index], offset);
    }
}
void lcd_clear() {
    int i;
    for(i = 0; i < ROWS * COLS; i++) {
        lcd_buffer[i] = 0x00;
    }
    cursor_x = 0;
    cursor_y = 0;
    lcd_update();
}
void lcd_putc(unsigned char c) {
    int i = 0, index = cursor_x + cursor_y * COLS;
    int char_index;
    if (c < 32 || c > 127) c = ' ';
	char_index = ((c - 32) * 6);
    for(i = 0; i < 6; i++) {
     lcd_buffer[index + i] = lcd_font[char_index + i];   
    }
    cursor_x += CHAR_WIDTH;
    if(cursor_x > 120) {
        cursor_x = 0;
        cursor_y += 1;
    }
    if(cursor_y > 3) {
        cursor_y = 0;
    }
}
void lcd_puts(unsigned char * s) {
    while(*s) {
        lcd_putc(*s);
        s++;
    }
}
void lcd_newline() {
    if(cursor_y >= 3) {
        cursor_x = 0;
        cursor_y = 3;
        lcd_vertical_shift();
    } else {
        cursor_y += 1;
        cursor_x = 0;
    }
}
void lcd_vertical_shift() {
    int i = 0;
    for(i = 0; i < 3 * COLS; i++) {
        lcd_buffer[i] = lcd_buffer[i + COLS]; 
    }
    for(; i < ROWS * COLS; i++) {
        lcd_buffer[i] = 0;
    }
}